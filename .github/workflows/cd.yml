name: CD - Deploy to EKS

on:
  workflow_run:
    workflows: ["CI - Build and Push to ECR"]
    types:
      - completed
    branches:
      - main
      - develop
  workflow_dispatch:  # Manual trigger
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      image_tag:
        description: 'Image tag to deploy'
        required: false
        default: 'latest'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    
    # Only run if CI succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
            TAG="${{ github.event.inputs.image_tag }}"
          else
            # Auto-determine from branch
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              ENV="prod"
              TAG="latest"
            elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
              ENV="dev"
              TAG="latest"
            else
              ENV="dev"
              TAG="latest"
            fi
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "image_tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Deploying to: $ENV"
          echo "ðŸ·ï¸  Image tag: $TAG"
      
      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
          role-session-name: GitHubActions-CD-${{ github.run_id }}
      
      - name: Update kubeconfig
        run: |
          # Update kubeconfig for the appropriate cluster
          CLUSTER_NAME="test-${{ steps.env.outputs.environment }}-eks-cluster"
          echo "ðŸ”— Connecting to cluster: $CLUSTER_NAME"
          
          aws eks update-kubeconfig \
            --name $CLUSTER_NAME \
            --region ${{ secrets.AWS_REGION || 'us-east-1' }}
          
          # Verify connection
          kubectl cluster-info
          kubectl get nodes
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace app --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy with Kustomize
        run: |
          ENV=${{ steps.env.outputs.environment }}
          TAG=${{ steps.env.outputs.image_tag }}
          ECR_REPO="${{ secrets.ECR_REPOSITORY_URL || '184890426414.dkr.ecr.us-east-1.amazonaws.com/image-gallery' }}"
          S3_BUCKET="${{ secrets.S3_BUCKET_NAME || 'image-gallery-dev-images' }}"
          
          echo "ðŸš€ Deploying to $ENV environment..."
          echo "ðŸ“¦ Image: $ECR_REPO:$TAG"
          echo "ðŸª£ S3 Bucket: $S3_BUCKET"
          
          cd k8s/overlays/$ENV
          
          # Set image tag in kustomization
          kustomize edit set image IMAGE_PLACEHOLDER=$ECR_REPO:$TAG
          
          # Inject S3 bucket name into ConfigMap
          kustomize edit set configmap image-gallery-config \
            --from-literal=S3_BUCKET=$S3_BUCKET \
            --behavior=merge
          
          # Show what will be applied
          echo "ðŸ“ Generated manifests:"
          kubectl kustomize .
          
          # Apply manifests
          kubectl apply -k .
          
          echo "âœ… Manifests applied"
      
      - name: Wait for rollout
        run: |
          ENV=${{ steps.env.outputs.environment }}
          DEPLOYMENT_NAME="${ENV}-image-gallery"
          
          echo "â³ Waiting for rollout to complete..."
          
          kubectl rollout status deployment/$DEPLOYMENT_NAME -n app --timeout=5m
          
          echo "âœ… Rollout completed successfully"
      
      - name: Verify deployment
        run: |
          ENV=${{ steps.env.outputs.environment }}
          DEPLOYMENT_NAME="${ENV}-image-gallery"
          
          echo "ðŸ” Verifying deployment..."
          
          # Get deployment status
          kubectl get deployment $DEPLOYMENT_NAME -n app
          
          # Get pods
          kubectl get pods -n app -l app=image-gallery,environment=$ENV
          
          # Get service
          kubectl get svc -n app
          
          # Check pod health
          READY_PODS=$(kubectl get pods -n app -l app=image-gallery,environment=$ENV -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}' | grep -o "True" | wc -l)
          TOTAL_PODS=$(kubectl get pods -n app -l app=image-gallery,environment=$ENV --no-headers | wc -l)
          
          echo "ðŸ“Š Ready pods: $READY_PODS/$TOTAL_PODS"
          
          if [ "$READY_PODS" -eq "$TOTAL_PODS" ] && [ "$TOTAL_PODS" -gt 0 ]; then
            echo "âœ… All pods are ready!"
          else
            echo "âŒ Some pods are not ready"
            kubectl describe pods -n app -l app=image-gallery,environment=$ENV
            exit 1
          fi
      
      - name: Get application URL
        id: url
        run: |
          # If using LoadBalancer or Ingress, get external URL
          # For now, show ClusterIP
          SVC_IP=$(kubectl get svc -n app -l app=image-gallery -o jsonpath='{.items[0].spec.clusterIP}')
          echo "ðŸŒ Service IP: $SVC_IP"
          echo "service_ip=$SVC_IP" >> $GITHUB_OUTPUT
      
      - name: Summary
        run: |
          ENV=${{ steps.env.outputs.environment }}
          TAG=${{ steps.env.outputs.image_tag }}
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ Deployment Summary
          
          - **Environment**: \`$ENV\`
          - **Image Tag**: \`$TAG\`
          - **Cluster**: \`test-$ENV-eks-cluster\`
          - **Namespace**: \`app\`
          - **Service IP**: \`${{ steps.url.outputs.service_ip }}\`
          
          ### Deployment Status
          \`\`\`
          $(kubectl get deployment -n app -l environment=$ENV)
          \`\`\`
          
          ### Pods
          \`\`\`
          $(kubectl get pods -n app -l environment=$ENV)
          \`\`\`
          EOF
